<!DOCTYPE html>
<html lang="en">

<head>
  <%- include("../include/headLink")%>
    <!-- Title Page-->
    <title>Fabricate Entry</title>
</head>

<body class="animsition">
  <div class="page-wrapper">
    <!-- HEADER MOBILE-->
    <%- include("../include/navbar") %>
      <!-- PAGE CONTAINER-->
      <div class="page-container">
        <!-- HEADER DESKTOP-->
        <%- include("../include/header")%>
          <!-- MAIN CONTENT-->
          <div class="main-content">
            <div class="section__content section__content--p30">
              <div class="container-fluid">
                <form action="/create-fabricate-item" method="POST">
                  <div class="row">
                    <div class="col-lg-12">
                      <div class="card">
                        <div class="card-header">Fabricate Entry</div>
                        <div class="card-body">
                          <div class="card-title">
                            <h3 class="text-center title-2">Fabricate Entry</h3> </div>
                          <hr>
                            <table class="table table-bordered table-striped">
                              <tbody>
                                <tr>
                                      <td>Order No.</td>
                                      <td><%= fabricateItem[0].order[0].orderNo %></td>
                                  </tr>
                                  <tr>
                                      <td>Fabricate Item Name</td>
                                      <td><%= fabricateItem[0].itemName[0].itemName %></td>
                                  </tr>
                                  <tr>
                                      <td>Fabricate Qty</td>
                                      <td><%= fabricateItem[0].quantity %></td>
                                  </tr>
                                  <tr>
                                      <td>Fabricate Total Sq.Ft.</td>
                                      <td><%= fabricateItem[0].totalSqft %></td>
                                  </tr>
                                  <tr>
                                      <td>Fabricate Rate</td>
                                      <td><%= fabricateItem[0].rate %></td>
                                  </tr>
                                  <tr>
                                      <td>Fabricate Amount</td>
                                      <td><%= fabricateItem[0].totalSqft * fabricateItem[0].rate %></td>
                                  </tr>
                              </tbody>
                            </table>
                            <input type="hidden" name="orderId" value="<%= fabricateItem[0].order[0]._id %>">
                            <input type="hidden" name="fabricateItemId" value="<%= fabricateItem[0]._id %>">
                            <hr>
                            <h3>Add Used Item Details</h3>
                            <hr>
                            <div class="table-responsive m-b-40">
                                    <table class="table table-borderless table-data3" id="enquiryDataTable">
                                        <thead>
                                            <th style="width: 5%;">S.No</th>
                                            <th>Stock Group</th>
                                            <th>Stock Item</th>
                                            <th style="width: 15%">Size</th>
                                            <th style="width: 20%">Amount</th>
                                        </thead>
                                        <tbody id="addItem">
                                            <tr>
                                              <td>
                                                1
                                              </td>
                                              <td>
                                                <select class="form-control-sm form-control itemGroup" data-count="0" id="itemGroup0" name="itemGroupId[0]" required>
                                                  
                                                </select>
                                              </td>
                                              <td>
                                                <select class="form-control-sm form-control" id="itemName0" name="itemId[0]">
                                                  
                                                </select>
                                              </td>
                                              <td>
                                                <input type="text" id="input-small" class="input-sm form-control-sm form-control" name="size[0]" placeholder="Enter Size">
                                              </td>
                                              <td>
                                              </td>  
                                            </tr>

                                            <tr>
                                              <td id="addItemButton1">
                                                <div class="table-data-feature">
                                                  <button class="item add" type="button" data-placement="top"><i class="zmdi zmdi-plus-square"></i></button>
                                                </div>
                                              </td>
                                              <td>
                                                <input type="number" id="quantity0" class="input-sm form-control-sm form-control" step=".01" name="quantity[0]" placeholder="Enter Quantity">
                                              </td>
                                              <td>
                                                <input type="number" id="totalSqft0" class="input-sm form-control-sm form-control change" data-count="0" step=".01" name="totalSqft[0]" placeholder="Enter Total Sq.Ft.">
                                              </td>
                                              <td>
                                                <input type="number" id="rate0" class="input-sm form-control-sm form-control change" step=".01" data-count="0"  name="rate[0]" placeholder="Enter Rate">
                                              </td>
                                              <td>
                                                <input type="number" class="input-sm form-control-sm form-control" placeholder="Amount" id="amount0" disabled>
                                              </td>
                                            </tr>
                                            </tbody>
                                            <tbody>
                                            
                                              <tr style=" border-top: 2px dashed #000;">
                                                <td colspan="4" style="text-align: left; font-size: 15px;">
                                                  <b>Total Amount:</b>
                                                </td>
                                                <td>
                                                  <input type="number" class="input-sm form-control-sm form-control" placeholder="Total Amount" id="itemTotalAmount" disabled>
                                                </td>
                                              </tr>
                                              <tr>
                                                <td colspan="4" style="text-align: left; font-size: 15px;">
                                                  <b>RoundOff:</b>
                                                </td>
                                                <td>
                                                  <input type="number" id="discount" class="input-sm form-control-sm form-control calculationChange" name="roundOff" step=".01" placeholder="Enter Discount" value="0">
                                                </td>
                                              </tr>
                                              <tr style="border-top: 2px solid #000; border-bottom: 2px solid #000;">
                                                <td colspan="4" style="text-align: left; font-size: 15px;">
                                                  <b>Total Amount:</b>
                                                </td>
                                                <td>
                                                  <input type="number" class="input-sm form-control-sm form-control" placeholder="Final Total Amount" id="finalAmount" disabled>
                                                </td>
                                              </tr>
                                            </tbody>
                                          
                                    </table>
                                </div>
                            <hr>
                            <h3>Add other Fabricate Item Details</h3>
                            <hr>
                            <div class="table-responsive m-b-40">
                                    <table class="table table-borderless table-data3" id="enquiryDataTable">
                                        <thead>
                                            <th style="width: 5%;">S.No</th>
                                            <th>Stock Group</th>
                                            <th>Stock Item</th>
                                            <th style="width: 15%">Size</th>
                                            <th style="width: 20%">Amount</th>
                                        </thead>
                                        <tbody id="addItemFab">
                                            <tr>
                                              <td>
                                                1
                                              </td>
                                              <td>
                                                <input type="text" class="input-sm form-control-sm form-control" value="<%= fabricateItem[0].itemGroup[0].itemGroupName %>"  name="itemGroupIdFab[0]" disabled>

                                                <input type="hidden" value="<%= fabricateItem[0].itemGroup[0]._id %>"  name="itemGroupIdFab[0]">
                                              </td>
                                              <td>
                                                <input type="text" class="input-sm form-control-sm form-control" value="<%= fabricateItem[0].itemName[0].itemName %>" name="itemIdFab[0]" disabled>

                                                <input type="hidden" value="<%= fabricateItem[0].itemName[0]._id %>" name="itemIdFab[0]">
                                              </td>
                                              <td>
                                                <input type="text" class="input-sm form-control-sm form-control" value="<%= fabricateItem[0].size %>" name="sizeFab[0]" disabled>

                                                <input type="hidden" value="<%= fabricateItem[0].size %>" name="sizeFab[0]">
                                              </td>
                                              <td>
                                              </td>  
                                            </tr>

                                            <tr>
                                              <td id="addItemButton1">
                                                <div class="table-data-feature">
                                                  <button class="item addFab" type="button" data-placement="top"><i class="zmdi zmdi-plus-square"></i></button>
                                                </div>
                                              </td>
                                              <td>
                                                <input type="number" id="quantity0" class="input-sm form-control-sm form-control" step=".01" value="<%= fabricateItem[0].quantity %>" name="quantityFab[0]" disabled>

                                                <input type="hidden" step=".01" value="<%= fabricateItem[0].quantity %>" name="quantityFab[0]">
                                              </td>
                                              <td>
                                                <input type="number" id="totalSqft0" class="input-sm form-control-sm form-control change" data-count="0" step=".01" value="<%= fabricateItem[0].totalSqft %>" name="totalSqftFab[0]" disabled>

                                                <input type="hidden" value="<%= fabricateItem[0].totalSqft %>" name="totalSqftFab[0]">
                                              </td>
                                              <td>
                                                <input type="number" id="rate0" class="input-sm form-control-sm form-control change" step=".01" data-count="0" value="<%= fabricateItem[0].rate %>" name="rateFab[0]" disabled>

                                                <input type="hidden" value="<%= fabricateItem[0].rate %>" name="rateFab[0]">
                                              </td>
                                              <td>
                                                <input type="number" class="input-sm form-control-sm form-control" placeholder="Amount" id="amountFab0" value="<%= fabricateItem[0].rate * fabricateItem[0].totalSqft %>" disabled>
                                              </td>
                                            </tr>
                                            </tbody>
                                            <tbody>
                                            
                                              <tr style=" border-top: 2px dashed #000;">
                                                <td colspan="4" style="text-align: left; font-size: 15px;">
                                                  <b>Total Amount:</b>
                                                </td>
                                                <td>
                                                  <input type="number" class="input-sm form-control-sm form-control" placeholder="Total Amount" id="itemTotalAmountFab" disabled>
                                                </td>
                                              </tr>
                                              <tr>
                                                <td colspan="4" style="text-align: left; font-size: 15px;">
                                                  <b>RoundOff:</b>
                                                </td>
                                                <td>
                                                  <input type="number" id="discountFab" class="input-sm form-control-sm form-control calculationChangeFab" name="roundOffFab" step=".01" placeholder="Enter Roundoff" value="0">
                                                </td>
                                              </tr>
                                              <tr style="border-top: 2px solid #000; border-bottom: 2px solid #000;">
                                                <td colspan="4" style="text-align: left; font-size: 15px;">
                                                  <b>Total Amount:</b>
                                                </td>
                                                <td>
                                                  <input type="number" class="input-sm form-control-sm form-control" placeholder="Final Total Amount" id="finalAmountFab" disabled>
                                                </td>
                                              </tr>
                                            </tbody>
                                          
                                    </table>
                                </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="form-group">
                                  <label for="enquiryDate" class="control-label mb-1">Comment:- </label>
                                  <input type="text" class="form-control" name="comment" placeholder="Enter Comment">
                                </div>
                    
                  <input type="text" name="totalItem" id="totalItemNo" value="0">
                  <input type="text" name="totalItemFab" id="totalItemNoFab" value="0">
                  <button type="submit" class="btn btn-lg btn-info btn-block submitData"> <span id="payment-button-amount">Submit</span> </button>
                </form>
              </div>
            </div>
          </div>
      </div>
      <!-- Jquery JS-->
      <%- include("../include/jsLink") %>
        <script>
        $(document).ready(function() {

          //fabricate Item

          var countFab = 0;
        var itemDataFab = "";
        var buttonData = "";

        $(document).on('click', '.removeFab', function(){ 

          var itemRowCount = $(this).data("count");

          $('.itemFab'+itemRowCount).html(" ");

          calculationFab();

        })

        $(document).on('click', '.addFab', function(){ 

          countFab++;

          itemDataFab += '<tr class="itemFab'+countFab+'">'
          itemDataFab += '<td>'+(countFab + 1)+'</td>'
          itemDataFab += '<td><select class="form-control-sm form-control itemGroupFab" data-count="'+countFab+'" id="itemGroupFab'+countFab+'" name="itemGroupIdFab['+countFab+']"></select></td>'
          
          itemGroupListFab();

          itemDataFab += '<td><select class="form-control-sm form-control"  id="itemNameFab'+countFab+'" name="itemIdFab['+countFab+']"></select></td>'

          itemDataFab += '<td><input type="text" id="input-small" class="input-sm form-control-sm form-control" name="sizeFab['+countFab+']" placeholder="Enter Size"></td>'
          itemDataFab += '<td></td>'
          itemDataFab += '</tr>'
          itemDataFab += '<tr class="itemFab'+countFab+'">'
          itemDataFab += '<td id="addItemButtonFab'+(countFab+1)+'"><div class="table-data-feature"><button class="item addFab" type="button" data-placement="top"><i class="zmdi zmdi-plus-square"></i></button></div></td>'

          itemDataFab += '<td><input type="number" class="input-sm form-control-sm form-control" step=".01" name="quantityFab['+countFab+']" placeholder="Enter Quantity"></td>'

          itemDataFab += '<td><input type="number" id="totalSqftFab'+countFab+'" class="input-sm form-control-sm form-control changeFab" step=".01" data-count="'+countFab+'" name="totalSqftFab['+countFab+']" placeholder="Enter Total Sq.Ft."></td>'


          itemDataFab += '<td><input type="number" id="rateFab'+countFab+'" class="input-sm form-control-sm form-control changeFab" step=".01" data-count="'+countFab+'" name="rateFab['+countFab+']" placeholder="Enter Rate"></td>'
          
          itemDataFab += '<td><input type="number" class="input-sm form-control-sm form-control" placeholder="Amount" id="amountFab'+countFab+'" disabled></td>'                                            
          itemDataFab += '</tr>'   

          if (countFab == 1) {

            buttonDataFab = "";
          } else {

            buttonDataFab += '<div class="table-data-feature">';
            buttonDataFab += '<button class="item removeFab" type="button" data-count="'+(countFab-1)+'" data-placement="top"><i class="zmdi zmdi-minus-square"></i></button>'
            buttonDataFab += '</div>'
          }  


          $('#addItemFab').append(itemDataFab);
          $('#addItemButtonFab'+countFab).html(buttonDataFab);
          $('#totalItemNoFab').val(countFab);


          itemDataFab = "";   
          buttonDataFab = "";
                     
        });

          itemGroupList();

      //Item Group

      var selectItemGroup = '<option>Select Item Group</option>';

      function itemGroup(data, index) {

        selectItemGroup += '<option value="' + data._id + '">' + data.itemGroupName + '</option>'
      }

      

      function itemGroupListFab() {
        var modelData = "";
        $.ajax({
          url: '/all-item-group',
          method: 'get',
          dataType: 'json',
          success: function(response) {
            if(response.msg == 'success') {
              
              selectItemGroup = "'<option>Select Item Group</option>'";
              response.itemGroup.forEach((data, index) => {
                itemGroup(data, index);
              });
              $('#itemGroupFab'+countFab).html(selectItemGroup);
            }
          }
        })
      }

      //Item Name
      var selectItemName = "";

      function itemName(data, index) {

        selectItemName += '<option value="' + data._id + '">' + data.itemName + '</option>'
      }

      $(document).on('change', '.itemGroupFab', function(){

        console.log('1');

        var itemGroupId = $(this).val();
        var itemGroupCount = $(this).data("count");  

        $.ajax({
          url:'/all-item-name/'+itemGroupId,
          method:'get',
          dataType: 'json',
          success:function(response)
          {
            selectItemName = "";
            response.itemName.forEach((data, index) => {
              itemName(data, index);
            });
            $('#itemNameFab'+itemGroupCount).html(selectItemName);
          }
        })
      });

                //Amount Calculation

          var quantityFab = 0;
          var rateFab = 0;
          var amountFab = 0;
          var itemAmountFab = 0;
          var itemTotalAmountFab = 0;
          var discountFab = 0;
          var finalAmountFab = 0;


          $(document).on('change', '.changeFab', function(){
                
                var changeCount = $(this).data("count");  

                quantityFab = parseFloat(document.getElementById('totalSqftFab'+changeCount).value);
                rateFab = parseFloat(document.getElementById('rateFab'+changeCount).value);

                amountFab = (quantityFab * rateFab).toFixed(2);
                $('#amountFab'+changeCount).val(amountFab);

                calculationFab();

                

            });

          $(document).on('change', '.calculationChangeFab', function(){

            calculationFab();
          });

          function calculationFab(){

              for (var i = 0; i <= countFab; i++) {

                  itemAmountFab = parseFloat(document.getElementById('amountFab'+i).value);

                  if (Number.isNaN(itemAmountFab)) {

                    itemAmountFab = 0;
                  }

                  itemTotalAmountFab = parseFloat((itemTotalAmountFab + itemAmountFab).toFixed(2));
                  itemAmountFab = 0;
                  
                }
                $('#itemTotalAmountFab').val(itemTotalAmountFab);


                discountFab = parseFloat(document.getElementById('discountFab').value);

                finalAmountFab = itemTotalAmountFab - discountFab;

                $('#finalAmountFab').val(finalAmountFab);

                quantityFab = 0;
                rateFab = 0;
                amountFab = 0;
                itemAmountFab = 0;
                itemTotalAmountFab = 0;
                discountFab = 0;
                finalAmountFab = 0;
          }

          //End of Fabricate Item

          var count = 0;
        var itemData = "";
        var buttonData = "";

        $(document).on('click', '.remove', function(){ 

          var itemRowCount = $(this).data("count");

          $('.item'+itemRowCount).html(" ");

          calculation();

        })

        $(document).on('click', '.add', function(){ 

          count++;

          itemData += '<tr class="item'+count+'">'
          itemData += '<td>'+(count + 1)+'</td>'
          itemData += '<td><select class="form-control-sm form-control itemGroup" data-count="'+count+'" id="itemGroup'+count+'" name="itemGroupId['+count+']"></select></td>'
          
          itemGroupList();

          itemData += '<td><select class="form-control-sm form-control"  id="itemName'+count+'" name="itemId['+count+']"></select></td>'

          itemData += '<td><input type="text" id="input-small" class="input-sm form-control-sm form-control" name="size['+count+']" placeholder="Enter Size"></td>'
          itemData += '<td></td>'
          itemData += '</tr>'
          itemData += '<tr class="item'+count+'">'
          itemData += '<td id="addItemButton'+(count+1)+'"><div class="table-data-feature"><button class="item add" type="button" data-placement="top"><i class="zmdi zmdi-plus-square"></i></button></div></td>'

          itemData += '<td><input type="number" id="quantity'+count+'" class="input-sm form-control-sm form-control" step=".01" name="quantity['+count+']" placeholder="Enter Quantity"></td>'

          itemData += '<td><input type="number" id="totalSqft'+count+'" class="input-sm form-control-sm form-control change" step=".01" data-count="'+count+'" name="totalSqft['+count+']" placeholder="Enter Total Sq.Ft."></td>'


          itemData += '<td><input type="number" id="rate'+count+'" class="input-sm form-control-sm form-control change" step=".01" data-count="'+count+'" name="rate['+count+']" placeholder="Enter Rate"></td>'
          
          itemData += '<td><input type="number" class="input-sm form-control-sm form-control" placeholder="Amount" id="amount'+count+'" disabled></td>'                                            
          itemData += '</tr>'   

          if (count == 1) {

            buttonData = "";
          } else {

            buttonData += '<div class="table-data-feature">';
            buttonData += '<button class="item remove" type="button" data-count="'+(count-1)+'" data-placement="top"><i class="zmdi zmdi-minus-square"></i></button>'
            buttonData += '</div>'
          }  


          $('#addItem').append(itemData);
          $('#addItemButton'+count).html(buttonData);
          $('#totalItemNo').val(count);


          itemData = "";   
          buttonData = "";
                     
        });

          itemGroupList();

      //Item Group

      var selectItemGroup = '<option>Select Item Group</option>';

      function itemGroup(data, index) {

        selectItemGroup += '<option value="' + data._id + '">' + data.itemGroupName + '</option>'
      }

      

      function itemGroupList() {
        var modelData = "";
        $.ajax({
          url: '/all-item-group',
          method: 'get',
          dataType: 'json',
          success: function(response) {
            if(response.msg == 'success') {

              selectItemGroup = "'<option>Select Item Group</option>'";
              response.itemGroup.forEach((data, index) => {
                itemGroup(data, index);
              });
              $('#itemGroup'+count).html(selectItemGroup);
            }
          }
        })
      }

      //Item Name
      var selectItemName = "";

      function itemName(data, index) {

        selectItemName += '<option value="' + data._id + '">' + data.itemName + '</option>'
      }

      $(document).on('change', '.itemGroup', function(){

        console.log('1');

        var itemGroupId = $(this).val();
        var itemGroupCount = $(this).data("count");  

        $.ajax({
          url:'/all-item-name/'+itemGroupId,
          method:'get',
          dataType: 'json',
          success:function(response)
          {
            selectItemName = "";
            response.itemName.forEach((data, index) => {
              itemName(data, index);
            });
            $('#itemName'+itemGroupCount).html(selectItemName);
          }
        })
      });

                //Amount Calculation

          var quantity = 0;
          var rate = 0;
          var amount = 0;
          var itemAmount = 0;
          var itemTotalAmount = 0;
          var packingCharge = 0;
          var transportCharge = 0;
          var fittingCharge = 0;
          var totalAmount = 0;
          var gst = 0;
          var gstAmount = 0;
          var discount = 0;
          var finalAmount = 0;


          $(document).on('change', '.change', function(){
                
                var changeCount = $(this).data("count");  

                quantity = parseFloat(document.getElementById('totalSqft'+changeCount).value);
                rate = parseFloat(document.getElementById('rate'+changeCount).value);

                amount = (quantity*rate).toFixed(2);
                $('#amount'+changeCount).val(amount);

                calculation();

                

            });

          $(document).on('change', '.calculationChange', function(){

            calculation();
          });

          function calculation(){

              for (var i = 0; i <= count; i++) {

                  itemAmount = parseFloat(document.getElementById('amount'+i).value);

                  if (Number.isNaN(itemAmount)) {

                    itemAmount = 0;
                  }

                  itemTotalAmount = parseFloat((itemTotalAmount + itemAmount).toFixed(2));
                  itemAmount = 0;
                  
                }
                $('#itemTotalAmount').val(itemTotalAmount);


                totalAmount = parseFloat((itemTotalAmount).toFixed(2));

                $('#totalAmount').val(totalAmount);


                discount = parseFloat(document.getElementById('discount').value);

                finalAmount = totalAmount - discount;

                $('#finalAmount').val(finalAmount);

                quantity = 0;
                rate = 0;
                amount = 0;
                itemAmount = 0;
                itemTotalAmount = 0;
                packingCharge = 0;
                transportCharge = 0;
                fittingCharge = 0;
                totalAmount = 0;
                gst = 0;
                gstAmount = 0;
                discount = 0;
                finalAmount = 0;
          }


          //Contractor
          var selectOption = '<option value=""> Select Contractor</option>';

          function marketingPerson(data, index) {
            selectOption += '<option value="' + data._id + '">' + data.name + '</option>'
          }

          var modelData = "";
          $.ajax({
            url: '/all-user',
            method: 'get',
            dataType: 'json',
            success: function(response) {
              if(response.msg == 'success') {
                response.user.forEach((data, index) => {
                  marketingPerson(data, index);
                });
                $('#marketingPerson').html(selectOption);
                $('#mpMarketingPerson').html(selectOption);
              }
            }
          })
        });
        </script>
</body>

</html>
<!-- end document-->