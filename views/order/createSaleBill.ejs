<!DOCTYPE html>
<html lang="en">

<head>
  <%- include("../include/headLink")%>
    <!-- Title Page-->
    <title>Create Sale Bill</title>
</head>

<body class="animsition">
  <div class="page-wrapper">
    <!-- HEADER MOBILE-->
    <%- include("../include/navbar") %>
      <!-- PAGE CONTAINER-->
      <div class="page-container">
        <!-- HEADER DESKTOP-->
        <%- include("../include/header")%>
          <!-- MAIN CONTENT-->
          <div class="main-content">
            <div class="section__content section__content--p30">
              <div class="container-fluid">
                <form action="/create-sale-bill" method="POST">
                  <div class="row">
                    <div class="col-md-6">
                            <h3 class="text-center title-2">Create Sale Bill</h3> 
                      <hr>
                            <div class="form-group">
                              <label for="enquiryDate" class="control-label mb-1">Bill No</label>

                              <input id="enquiryDate" name="billNo" type="text" placeholder="Enter Bill No." class="form-control" aria-required="true" aria-invalid="false" required> 

                              <input name="partyId" type="hidden" id="partyId"> 
                            </div>
                            <div id="secondLedger">
                              
                              
                            </div>
                    </div>
                    <div class="col-md-1">
                    </div>
                    <div class="col-md-5">
                            <h3 class="text-center title-2">Add Order</h3> 
                      <hr>
                            <div class="form-group">
                              <label for="enquiryDate" class="control-label mb-1">Add Order</label>
                              <select name="order" id="selectOrder" class="form-control">
                                
                              </select> 
                            </div>
                    </div>
                  </div>
                  <br>
                  <h3 class="text-center title-2">Added Orders-:</h3>
                  <hr>
                  <div class="table-responsive m-b-40">
                      <table class="table table-borderless table-data3" id="enquiryDataTable">
                          <thead>
                              <th style="width: 5%;">S.No</th>
                              <th>Order No.</th>
                              <th style="width: 20%">Amount</th>
                          </thead>
                          <tbody id="orderData">
                          </tbody>
                          <tbody>
                                            
                                              <tr style=" border-top: 2px dashed #000;">
                                                <td colspan="2" style="text-align: left; font-size: 15px;">
                                                  <b>Total Amount:</b>
                                                </td>
                                                <td>
                                                  <input type="number" class="input-sm form-control-sm form-control" placeholder="Total Amount" id="itemTotalAmount" disabled>
                                                </td>
                                              </tr>
                                              <tr>
                                                <td colspan="2" style="text-align: left; font-size: 15px;">
                                                  <b>Packing Charge:</b>
                                                </td>
                                                <td>
                                                  <input type="number" id="packingCharge" class="input-sm form-control-sm form-control calculationChange" step=".01" name="packingCharge" placeholder="Enter Packaging Charge" value="0">
                                                </td>
                                              </tr>
                                              <tr>
                                                <td colspan="2" style="text-align: left; font-size: 15px;">
                                                  <b>Transport Charge:</b>
                                                </td>
                                                <td>
                                                  <input type="number" id="transportCharge" class="input-sm form-control-sm form-control calculationChange" name="transportCharge" step=".01" placeholder="Enter Transport Charge" value="0">
                                                </td>
                                              </tr>
                                              <tr>
                                                <td colspan="2" style="text-align: left; font-size: 15px;">
                                                  <b>Fitting Charge:</b>
                                                </td>
                                                <td>
                                                  <input type="number" id="fittingCharge" class="input-sm form-control-sm form-control calculationChange" name="fittingCharge" step=".01" placeholder="Enter Fitting Charge" value="0">
                                                </td>
                                              </tr>
                                              <tr style=" border-top: 2px dashed #000;">
                                                <td colspan="2" style="text-align: left; font-size: 15px;">
                                                  <b>Total Amount:</b>
                                                </td>
                                                <td>
                                                  <input type="number" class="input-sm form-control-sm form-control" placeholder="Total Amount" id="totalAmount" disabled>
                                                </td>
                                              </tr>
                                              <tr>
                                                <td style="text-align: left; font-size: 15px;">
                                                  <b>GST:</b>
                                                </td>
                                                <td style="text-align: right; font-size: 15px;">
                                                  <select class="form-control-sm form-control calculationChange" name="gst" id="gst">
                                                    
                                                    <option value="0">0</option>
                                                    <option value="0.05">5%</option>
                                                    <option value="0.12">12%</option>
                                                    <option value="0.18">18%</option>
                                                  </select>
                                                </td>
                                                <td>
                                                  <input type="number" class="input-sm form-control-sm form-control" placeholder="GST" step='.01' id="gstAmount" disabled>
                                                </td>
                                              </tr>
                                              <tr>
                                                <td colspan="2" style="text-align: left; font-size: 15px;">
                                                  <b>Discount:</b>
                                                </td>
                                                <td>
                                                  <input type="number" id="discount" class="input-sm form-control-sm form-control calculationChange" name="discount" step=".01" placeholder="Enter Discount" value="0">
                                                </td>
                                              </tr>
                                              <tr style="border-top: 2px solid #000; border-bottom: 2px solid #000;">
                                                <td colspan="2" style="text-align: left; font-size: 15px;">
                                                  <b>Total Amount:</b>
                                                </td>
                                                <td>
                                                  <input type="number" class="input-sm form-control-sm form-control" placeholder="Final Total Amount" id="finalAmount" disabled>
                                                </td>
                                              </tr>
                                            </tbody>
                      </table>
                  </div>
                  <div class="form-group">
                    <label for="enquiryDate" class="control-label mb-1">Comment:- </label>
                    <input type="text" class="form-control" name="comment" placeholder="Enter Comment">
                  </div>
                  <input type="hidden" name="totalOrder" id="totalOrderNo" value="0">
                  <input type="hidden" name="totalStock" id="totalStockNo" value="0">
                  <button type="submit" class="btn btn-lg btn-info btn-block submitData"> <span id="payment-button-amount">Submit</span> </button>
                </form>
              </div>
            </div>
          </div>
      </div>
      <!-- Jquery JS-->
      <%- include("../include/jsLink") %>
        <script>
        $(document).ready(function() {
          var selectOption = '<option value="">Select Order</option>';

          function confirmOrder(data, index) {

            selectOption += '<option value="' + data._id + '">' + data.orderNo + ' -- '+data.saleParty[0].shopName+ '</option>'
          }
          confirmOrderList();

          function confirmOrderList() {
            var modelData = "";
            $.ajax({
              url: '/all-pending-bill-confirm-order',
              method: 'get',
              dataType: 'json',
              success: function(response) {
                
                if(response.msg == 'success') {

                  response.confirmOrder.forEach((data, index) => {
                    confirmOrder(data, index);
                  });
                  $('#selectOrder').html(selectOption);
                }
              }
            })
          }

          function confirmPartyOrderList(data) {

            var partyId = data;
            
            $.ajax({
              url: '/all-party-confirm-order/'+data,
              method: 'get',
              dataType: 'json',
              success: function(response) {

                selectOption = "";
                
                if(response.msg == 'success') {

                  selectOption = '<option value="">Select Another Order</option>';

                  response.confirmOrder.forEach((data, index) => {
                    confirmOrder(data, index);
                  });
                  $('#selectOrder').html(selectOption);

                  if (response.confirmOrder[0].saleParty[0].secondLedger == 1) {

                    console.log("secondLedger");

                    $('#secondLedger').html('<div class="form-group"><label for="enquiryDate" class="control-label mb-1">Second Ledger</label><select class="form-control" name="secondLedger"><option value="0">No</option><option value="1">Yes</option></select></div>');  
                  }
                  $('#partyId').val(partyId);
                }
              }
            })
          }

          var orderData = "";
          var amount = 0;
          var itemTotalAmount = 0;
          var totalOrderAmount = 0;
          var count = -1;
          var stockCount = 0;

          $(document).on('change', '#selectOrder', function(){

            count++;
            var orderId = $(this).val();

            $.ajax({
              url: '/search-order-id/'+orderId,
              method: 'get',
              dataType: 'json',
              success: function(response) {

                console.log(response);

                if(response.msg == 'success') {
                  
                  orderData += '<tr class="item'+(count+1)+'">'
                  orderData += '<td>'+(count+1)+'</td>'
                  orderData += '<input type="hidden" class="input-sm form-control-sm form-control"  name="orderId['+count+']" value="'+response.orders[0]._id+'">'

                  orderData += '<td>'+response.orders[0].orderNo+'</td>';
                  confirmPartyOrderList(response.orders[0].partyId);

                  for (var i = 0; i < response.orders[0].stock.length; i++) {

                    amount = response.orders[0].stock[i].totalSqft * response.orders[0].stock[i].rate;
                    itemTotalAmount += amount;

                    orderData += '<input type="hidden" class="input-sm form-control-sm form-control"  name="stockId['+stockCount+']" value="'+response.orders[0].stock[i]._id+'">'

                    stockCount++;


                  }

                  orderData += '<td><input type="number" class="input-sm form-control-sm form-control" value="'+(itemTotalAmount).toFixed(2)+'" id="amount'+(count)+'" disabled></td>'

                  orderData += '</tr>'

                  totalOrderAmount += itemTotalAmount;

                  itemTotalAmount = 0;

                  
                }
                $('#orderData').html(orderData);
                $('#itemTotalAmount').val(totalOrderAmount);
                $('#totalOrderNo').val(count);
                $('#totalStockNo').val(stockCount);
                calculation();
                
              }

            })
          });

          var quantity = 0;
          var rate = 0;
          var amount = 0;
          var itemAmount = 0;
          var itemTotalAmount = 0;
          var packingCharge = 0;
          var transportCharge = 0;
          var fittingCharge = 0;
          var totalAmount = 0;
          var gst = 0;
          var gstAmount = 0;
          var discount = 0;
          var finalAmount = 0;

          $(document).on('change', '.calculationChange', function(){

            calculation();
          });

          function calculation(){

            console.log('hit');

            console.log(count);
              for (var i = 0; i <= count; i++) {


                  itemAmount = parseFloat(document.getElementById('amount'+i).value);

                  if (Number.isNaN(itemAmount)) {

                    itemAmount = 0;
                  }

                  itemTotalAmount = parseFloat((itemTotalAmount + itemAmount).toFixed(2));
                  itemAmount = 0;
                  
                }
                $('#itemTotalAmount').val(itemTotalAmount);

                packingCharge = parseFloat(document.getElementById('packingCharge').value);
                transportCharge = parseFloat(document.getElementById('transportCharge').value);
                fittingCharge = parseFloat(document.getElementById('fittingCharge').value);

                totalAmount = parseFloat((itemTotalAmount + packingCharge + transportCharge + fittingCharge).toFixed(2));

                $('#totalAmount').val(totalAmount);

                gst = parseFloat(document.getElementById('gst').value);

                gstAmount = parseFloat((gst * totalAmount).toFixed(2));

                console.log(typeof(gstAmount))

                $('#gstAmount').val(gstAmount);

                discount = parseFloat(document.getElementById('discount').value);

                finalAmount = totalAmount + gstAmount - discount;

                $('#finalAmount').val(finalAmount);

                quantity = 0;
                rate = 0;
                amount = 0;
                itemAmount = 0;
                itemTotalAmount = 0;
                packingCharge = 0;
                transportCharge = 0;
                fittingCharge = 0;
                totalAmount = 0;
                gst = 0;
                gstAmount = 0;
                discount = 0;
                finalAmount = 0;
          }

          

        });
        </script>
</body>

</html>
<!-- end document-->